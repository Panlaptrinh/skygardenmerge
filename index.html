<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#a1c4fd">
    <title>Sky Garden Merge</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-top: #a1c4fd;
            --bg-mid: #c2e9fb;
            --bg-bottom: #fbc2eb;
            --text-dark: #2d3436;
        }

        @keyframes clouds {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        input, select {
            user-select: auto !important;
            -webkit-user-select: auto !important;
        }

        body, html {
            width: 100vw;
            height: 100dvh; 
            overflow: hidden; 
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-top) 0%, var(--bg-mid) 50%, var(--bg-bottom) 100%);
            background-size: 200% 200%;
            animation: clouds 15s ease infinite;
            -webkit-font-smoothing: antialiased;
        }

        #game-root {
            display: flex;
            width: 100%;
            height: 100dvh;
            padding: 8px;
            gap: 8px;
            flex-direction: column;
            transition: all 0.3s;
        }

        /* SIDEBAR (Tr√™n c√πng ·ªü D·ªçc, B√™n tr√°i/ph·∫£i ·ªü Ngang) */
        .right-sidebar {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 8px;
            flex-shrink: 0;
        }

        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            width: 100%;
            gap: 8px;
        }
        
        .hud-box {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #fff;
            border-radius: 12px;
            padding: 5px 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .hud-label { font-size: 10px; color: #636e72; text-transform: uppercase; font-weight: 900; }
        .hud-value { font-size: 20px; font-weight: 900; color: var(--text-dark); }

        .tools { display: flex; flex-direction: column; justify-content: space-between; gap: 4px; }
        .icon-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3); color: white;
            border: 2px solid #fff; border-radius: 50%;
            width: 32px; height: 32px; display: flex; justify-content: center; align-items: center;
            font-size: 14px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .icon-btn:active { transform: scale(0.9); }

        /* QUY·ªÄN TR·ª¢ GI√öP POWERUPS - N√ÇNG C·∫§P GIAO DI·ªÜN PREMIUM */
        .powerups-panel {
            display: flex;
            width: 100%;
            gap: 5px;
            justify-content: space-around;
        }
        .pu-btn {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
        }
        .pu-btn:active { transform: scale(0.9); }
        .pu-btn.disabled { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
        
        .pu-icon-wrapper {
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            border: 2px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.6);
            margin-bottom: 4px;
            position: relative;
            transition: all 0.3s;
        }
        
        .bg-wildcard { background: radial-gradient(circle at 30% 30%, #ff9a9e, #fecfef); border-color: #ffd32a; }
        .bg-reroll { background: radial-gradient(circle at 30% 30%, #84fab0, #8fd3f4); border-color: #00cec9; }
        .bg-delete { background: radial-gradient(circle at 30% 30%, #fab1a0, #ff7675); border-color: #ff7675; }

        .pu-btn.active .pu-icon-wrapper {
            border-color: #ff4757;
            box-shadow: 0 0 15px #ff4757, inset 0 0 10px #ff4757;
            animation: puPulse 1s infinite;
        }
        
        @keyframes puPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pu-name { 
            font-size: 10px; font-weight: 900; color: #2d3436; 
            white-space: nowrap; text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        
        .pu-cost-badge {
            font-size: 10px; font-weight: 900; color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 8px; border-radius: 12px; margin-top: 2px;
            display: flex; align-items: center; gap: 3px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Canvas Panel */
        .center-panel {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 0; 
            min-width: 0;
            padding: 2px;
        }
        
        .canvas-container {
            position: relative;
            width: 100%; 
            height: 100%;
            border-radius: 15px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
            box-shadow: inset 0 0 0 4px rgba(255,255,255,0.9), inset 0 0 15px rgba(255,255,255,0.5), 0 5px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: box-shadow 0.3s;
        }
        .canvas-container.targeting {
            box-shadow: inset 0 0 0 4px #ff7675, inset 0 0 30px rgba(255, 118, 117, 0.4), 0 5px 20px rgba(255, 118, 117, 0.3);
            cursor: crosshair;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            width: 100%; 
            height: 100%;
            touch-action: none; 
            z-index: 10;
            background: transparent; 
        }

        /* L·ªô tr√¨nh ti·∫øn h√≥a */
        .evo-panel {
            display: flex;
            align-items: center;
            width: 100%;
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            padding: 8px 12px;
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .evo-panel::-webkit-scrollbar { display: none; }
        
        .evo-title {
            font-size: 11px; font-weight: 900; color: #2d3436;
            margin-right: 15px; white-space: nowrap;
        }
        .evolution-list {
            display: flex; gap: 16px; align-items: center;
        }
        .evo-bubble {
            width: 34px; height: 34px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px; border: 2px solid #fff; flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
        }
        .evo-bubble:not(:last-child)::after {
            content: "‚ñ∂";
            position: absolute; right: -13px; top: 50%; transform: translateY(-50%);
            color: rgba(255,255,255,0.9); font-size: 10px; font-weight: bold;
        }

        /* RESPONSIVE LANDSCAPE */
        @media screen and (orientation: landscape) {
            #game-root { flex-direction: row; }
            
            .evo-panel {
                flex-direction: column; width: 85px; height: 100%;
                overflow-y: auto; overflow-x: hidden; padding: 15px 5px;
            }
            .evo-title { margin-right: 0; margin-bottom: 15px; text-align: center; }
            .evolution-list { flex-direction: column-reverse; gap: 18px; } 
            .evo-bubble:not(:last-child)::after {
                content: "‚ñ≤"; position: absolute; top: -15px; right: auto; left: 50%; transform: translateX(-50%) translateY(0);
            }

            .right-sidebar {
                width: 100px; height: 100%; justify-content: space-between;
            }
            .top-panel {
                flex-direction: column; width: 100px; height: 100%;
                justify-content: center; gap: 15px;
            }
            .hud-box { width: 100%; padding: 10px 5px; }
            .tools { flex-direction: row; width: 100%; justify-content: space-around; }
            .icon-btn { width: 38px; height: 38px; font-size: 16px;}
            
            /* Tinh ch·ªânh Icon Tr·ª£ Gi√∫p khi xoay ngang */
            .powerups-panel {
                flex-direction: column; width: 100%; gap: 12px; align-items: center;
            }
            .pu-icon-wrapper { width: 48px; height: 48px; font-size: 26px; margin-bottom: 2px; }
            .pu-name { font-size: 11px; }
            .pu-cost-badge { font-size: 11px; padding: 3px 8px; }
        }

        /* SVG Background Logo */
        .brand-logo-svg {
            position: absolute; top: 50%; left: 50%;
            width: 70%; max-width: 250px; transform: translate(-50%, -50%);
            opacity: 0.25; pointer-events: none; z-index: 1;
            animation: floatLogo 6s ease-in-out infinite;
        }

        /* V·∫°ch nguy hi·ªÉm */
        .danger-line-container {
            position: absolute; left: 0; width: 100%; height: 2px;
            z-index: 5; pointer-events: none; display: flex; justify-content: center; align-items: center;
            transition: top 0.3s;
        }
        .danger-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: repeating-linear-gradient(90deg, transparent, transparent 5px, rgba(255, 71, 87,0.8) 5px, rgba(255, 71, 87,0.8) 10px);
        }
        .danger-warning {
            background: rgba(255, 118, 117, 0.95); color: #fff; border: 2px solid #fff;
            padding: 3px 12px; border-radius: 12px; font-size: 10px; font-weight: 900;
            text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: pulse-warning 2s infinite; z-index: 6; position: absolute;
        }

        /* MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); 
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: #fff; padding: 25px 20px; border-radius: 20px; 
            text-align: center; width: 85%; max-width: 320px; 
            max-height: 85dvh; overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 3px solid #a1c4fd;
            display: flex; flex-direction: column; gap: 10px; align-items: stretch;
        }
        .modal-content h2 { color: #0984e3; font-size: 24px; font-weight: 900; margin: 0;}
        .modal-content p { color: #636e72; font-size: 13px; font-weight: bold; margin: 0 0 5px 0; }

        .custom-input { 
            width: 100%; padding: 12px 15px; border-radius: 10px; 
            border: 2px solid #a1c4fd; font-family: inherit; font-size: 16px; 
            font-weight: 700; text-align: left; outline: none; box-sizing: border-box; 
            background: #fff; color: #2d3436; appearance: none; -webkit-appearance: none;
            margin: 0;
        }
        .custom-input:focus { border-color: #fbc2eb; box-shadow: 0 0 5px rgba(251,194,235,0.5); }
        
        select.custom-input {
            background-image: url("data:image/svg+xml;utf8,<svg fill='%23636e72' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat; background-position-x: calc(100% - 10px); background-position-y: center;
            padding-right: 30px;
        }

        .primary-btn { 
            background: linear-gradient(to right, #a1c4fd, #fbc2eb); border: none; 
            padding: 14px; width: 100%; border-radius: 10px; color: #fff; 
            font-weight: 900; font-size: 16px; cursor: pointer; margin-top: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .primary-btn:active { transform: scale(0.95); }

        .leaderboard-mini {
            background: #f8f9fa; border-radius: 10px; padding: 10px;
            margin-top: 5px; text-align: left; border: 1px solid #dfe6e9;
        }
        .lb-title { font-size: 13px; font-weight: 900; color: #2d3436; text-align: center; margin-bottom: 5px; }
        .lb-item { display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0; border-bottom: 1px dashed #dfe6e9; }
        .lb-item:last-child { border-bottom: none; }
        .lb-name { font-weight: bold; color: #636e72; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        .lb-score { font-weight: 900; color: #0984e3; }

    </style>
</head>
<body>

<div id="game-root">
    
    <div class="right-sidebar">
        <!-- HUD CHUNG -->
        <div class="top-panel">
            <div class="hud-box">
                <div class="hud-label">ƒêi·ªÉm s·ªë</div>
                <div class="hud-value" id="score-display">0</div>
            </div>
            
            <div class="hud-box">
                <div class="hud-label">Ti·∫øp theo</div>
                <div id="next-item-preview" style="font-size:24px; margin-top:4px;">üå±</div>
            </div>

            <div class="tools">
                <button class="icon-btn" onclick="toggleBGM()" id="music-btn">üéµ</button>
                <button class="icon-btn" onclick="showStartModal()">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- QUY·ªÄN TR·ª¢ GI√öP (POWER-UPS) -->
        <div class="powerups-panel">
            <div class="pu-btn disabled" id="pu-wildcard" onclick="buyWildcard()">
                <div class="pu-icon-wrapper bg-wildcard">üåü</div>
                <div class="pu-name">V·∫°n NƒÉng</div>
                <div class="pu-cost-badge">üíé 200</div>
            </div>
            <div class="pu-btn disabled" id="pu-reroll" onclick="buyReroll()">
                <div class="pu-icon-wrapper bg-reroll">üîÑ</div>
                <div class="pu-name">ƒê·ªïi Ng·ªçc</div>
                <div class="pu-cost-badge">üíé 50</div>
            </div>
            <div class="pu-btn disabled" id="pu-delete" onclick="buyDelete()">
                <div class="pu-icon-wrapper bg-delete">üî®</div>
                <div class="pu-name">X√≥a Ng·ªçc</div>
                <div class="pu-cost-badge">üíé 100</div>
            </div>
        </div>
    </div>

    <!-- KHUNG GAME CH√çNH -->
    <main class="center-panel" id="center-panel">
        <div class="canvas-container" id="canvas-wrapper">
            
            <svg class="brand-logo-svg" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="glass" cx="40%" cy="30%" r="60%">
                        <stop offset="0%" stop-color="rgba(255,255,255,0.9)" />
                        <stop offset="40%" stop-color="rgba(255,255,255,0.2)" />
                        <stop offset="100%" stop-color="rgba(180,200,255,0.5)" />
                    </radialGradient>
                    <radialGradient id="orb" cx="30%" cy="30%" r="60%">
                        <stop offset="0%" stop-color="#fff" />
                        <stop offset="30%" stop-color="#ff9a9e" />
                        <stop offset="70%" stop-color="#a1c4fd" />
                        <stop offset="100%" stop-color="#fbc2eb" />
                    </radialGradient>
                    <radialGradient id="seedGrad" cx="30%" cy="30%" r="60%">
                        <stop offset="0%" stop-color="#e0f6c8" />
                        <stop offset="100%" stop-color="#86e3ce" />
                    </radialGradient>
                </defs>
                <circle cx="150" cy="110" r="95" fill="url(#glass)" stroke="rgba(255,255,255,0.9)" stroke-width="4"/>
                <circle cx="150" cy="110" r="95" fill="none" stroke="#fbc2eb" stroke-width="6" filter="blur(6px)" opacity="0.6"/>
                <path d="M110 75 Q110 50 135 50 Q150 25 170 50 Q195 50 195 75 Z" fill="#fff" opacity="0.95"/>
                <path d="M115 75 Q115 55 135 55 Q150 35 165 55 Q185 55 185 75 Z" fill="#fbc2eb" opacity="0.4"/>
                <g transform="translate(150, 85)">
                    <circle cx="0" cy="-12" r="7" fill="#f1c40f"/>
                    <circle cx="11" cy="-4" r="7" fill="#f1c40f"/>
                    <circle cx="7" cy="9" r="7" fill="#f1c40f"/>
                    <circle cx="-7" cy="9" r="7" fill="#f1c40f"/>
                    <circle cx="-11" cy="-4" r="7" fill="#f1c40f"/>
                    <circle cx="0" cy="0" r="8" fill="#f39c12"/>
                </g>
                <circle cx="115" cy="130" r="28" fill="url(#seedGrad)" stroke="rgba(255,255,255,0.6)" stroke-width="3"/>
                <path d="M105 130 Q115 115 125 130 M115 115 L115 140" stroke="#1b4d3e" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                <circle cx="155" cy="145" r="22" fill="url(#orb)" stroke="#fff" stroke-width="2"/>
                <path d="M175 155 Q160 120 195 105 Q185 135 175 155 Z" fill="#00b894"/>
                <path d="M175 155 Q155 135 140 125 Q155 145 175 155 Z" fill="#55efc4"/>
                <path d="M175 155 L175 175" stroke="#00b894" stroke-width="4" stroke-linecap="round"/>
                <text x="150" y="240" font-family="'Nunito', sans-serif" font-weight="900" font-size="34" fill="#fff" text-anchor="middle" stroke="#a1c4fd" stroke-width="9" paint-order="stroke" stroke-linejoin="round">SKY GARDEN</text>
                <text x="150" y="280" font-family="'Nunito', sans-serif" font-weight="900" font-size="32" fill="#fff" text-anchor="middle" stroke="#fbc2eb" stroke-width="9" paint-order="stroke" stroke-linejoin="round">MERGE</text>
            </svg>

            <div class="danger-line-container" id="danger-ui">
                <div class="danger-line"></div>
                <div class="danger-warning">Gi·ªõi h·∫°n h·ª£p th√†nh</div>
            </div>

            <canvas id="gameCanvas"></canvas>
        </div>
    </main>

    <!-- L·ªò TR√åNH -->
    <aside class="evo-panel">
        <div class="evo-title">Ti·∫øn H√≥a</div>
        <div class="evolution-list" id="evo-list"></div>
    </aside>

</div>

<!-- MODAL C√ÄI ƒê·∫∂T -->
<div class="modal active" id="start-modal">
    <div class="modal-content">
        <h2>Sky Garden</h2>
        <p id="welcome-msg">Gh√©p h·∫°t gi·ªëng t·∫°o C√¢y T·ªëi Th∆∞·ª£ng!</p>
        
        <input type="text" id="player-name-input" class="custom-input" placeholder="Nh·∫≠p t√™n..." maxlength="12">
        <select id="diff-select" class="custom-input">
            <option value="easy">Ch·∫ø ƒë·ªô: Th∆∞ gi√£n (D·ªÖ)</option>
            <option value="normal" selected>Ch·∫ø ƒë·ªô: B√¨nh th∆∞·ªùng</option>
            <option value="hard">Ch·∫ø ƒë·ªô: √Åc m·ªông (Kh√≥, n·∫£y m·∫°nh)</option>
        </select>
        
        <button class="primary-btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U CH∆†I</button>
        
        <div class="leaderboard-mini">
            <div class="lb-title">üèÜ K·ª∑ l·ª•c tr√™n thi·∫øt b·ªã n√†y</div>
            <div id="lb-list">
                <div class="lb-item" style="justify-content:center; color:#999;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="game-over-modal">
    <div class="modal-content">
        <h2 style="color: #d63031;">V∆∞·ªùn ƒê√£ ƒê·∫ßy!</h2>
        <p>ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
        <div style="font-size: 36px; font-weight: 900; color: #0984e3; margin: 10px 0;" id="final-score">0</div>
        <button class="primary-btn" onclick="showStartModal()">CH∆†I L·∫†I</button>
    </div>
</div>

<script>
    const LEVELS = [
        { level: 1, name: "H·∫°t gi·ªëng", icon: "üå±", color: "#b5e7a0", radius: 28, mass: 1, points: 2 },
        { level: 2, name: "M·∫ßm c√¢y", icon: "üåø", color: "#86e3ce", radius: 40, mass: 2, points: 4 },
        { level: 3, name: "C√¢y non", icon: "üçÄ", color: "#d0e6a5", radius: 55, mass: 4, points: 8 },
        { level: 4, name: "Hoa nh·ªè", icon: "üåº", color: "#ffdd94", radius: 72, mass: 8, points: 16 },
        { level: 5, name: "Hoa l·ªõn", icon: "üå∫", color: "#fa897b", radius: 92, mass: 16, points: 32 },
        { level: 6, name: "Tr∆∞·ªüng th√†nh", icon: "üå≥", color: "#ccabd8", radius: 115, mass: 32, points: 64 },
        { level: 7, name: "C·ªï th·ª•", icon: "üå≤", color: "#86af49", radius: 145, mass: 64, points: 128 },
        { level: 8, name: "C√¢y th·∫ßn", icon: "üåà", color: "#b39cd0", radius: 180, mass: 128, points: 256 },
        { level: 9, name: "Pha L√™", icon: "üîÆ", color: "#74b9ff", radius: 220, mass: 256, points: 512 },
        { level: 10, name: "V≈© Tr·ª•", icon: "üåå", color: "#0984e3", radius: 265, mass: 512, points: 1024 },
        { level: 11, name: "Sinh M·ªánh", icon: "üëë", color: "#fdcb6e", radius: 320, mass: 1024, points: 2048 }
    ];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: true });
    const wrapper = document.getElementById('canvas-wrapper');
    const centerPanel = document.getElementById('center-panel');

    const LOGICAL_MIN = 1000;
    let LOGICAL_WIDTH = 1000;
    let LOGICAL_HEIGHT = 1000; 
    let GAME_OVER_LINE = 150; 
    let dangerLinePercent = 0.18; 

    let scale = 1; 
    let canvasRect;
    let gameConfig = { bounce: 0.45 };
    let bodies = [], particles = [];
    let score = 0, gameState = 'START'; 
    let currentDropItem = null, nextItemLevel = 1;
    let mouseX = LOGICAL_WIDTH / 2;
    let canDrop = true; 
    let playerName = "Ng∆∞·ªùi Ch∆°i";
    
    // Tr·∫°ng th√°i k·ªπ nƒÉng
    let isTargetingDelete = false;

    let globalLeaderboard = JSON.parse(localStorage.getItem('skyGardenGH_v7')) || [];
    const sfxCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isBgmPlaying = false; 

    function initApp() {
        renderEvolutionPanel();
        loadPlayerData();
        
        let resizeTimeout;
        const observer = new ResizeObserver(() => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                window.requestAnimationFrame(() => {
                    resizeCanvas();
                });
            }, 100); 
        });
        
        if(centerPanel) observer.observe(centerPanel);
        window.requestAnimationFrame(() => resizeCanvas());
    }

    function renderEvolutionPanel() {
        const list = document.getElementById('evo-list');
        let html = "";
        LEVELS.forEach(lvl => {
            html += `<div class="evo-bubble" style="background: ${lvl.color}">${lvl.icon}</div>`;
        });
        list.innerHTML = html;
    }
    
    function loadPlayerData() {
        let savedName = localStorage.getItem('skyGardenNameV7');
        if(savedName) {
            document.getElementById('player-name-input').value = savedName;
            document.getElementById('welcome-msg').innerText = `M·ª´ng tr·ªü l·∫°i, ${savedName}!`;
            document.getElementById('welcome-msg').style.color = "#0984e3";
        }
        updateLeaderboardUI();
    }
    
    function updateLeaderboardUI() {
        const list = document.getElementById('lb-list');
        if (globalLeaderboard.length === 0) return;
        let html = "";
        globalLeaderboard.slice(0, 3).forEach((item, index) => {
            let medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
            html += `<div class="lb-item"><span class="lb-name">${medal} ${item.name}</span><span class="lb-score">${item.score}</span></div>`;
        });
        list.innerHTML = html;
    }
    
    function saveScore() {
        if(score > 0) {
            globalLeaderboard.push({ name: playerName, score: score });
            globalLeaderboard.sort((a, b) => b.score - a.score);
            globalLeaderboard = globalLeaderboard.slice(0, 10);
            localStorage.setItem('skyGardenGH_v7', JSON.stringify(globalLeaderboard));
            updateLeaderboardUI();
        }
    }

    function resizeCanvas() {
        if (!centerPanel || !wrapper) return;
        
        let panelRect = centerPanel.getBoundingClientRect();
        let availableWidth = panelRect.width - 4; 
        let availableHeight = panelRect.height - 4;
        
        if(availableWidth <= 0 || availableHeight <= 0) return;

        let targetRatio = LOGICAL_WIDTH / LOGICAL_HEIGHT;
        let screenRatio = availableWidth / availableHeight;
        
        let finalWidth, finalHeight;
        if (screenRatio > targetRatio) {
            finalHeight = availableHeight;
            finalWidth = finalHeight * targetRatio;
        } else {
            finalWidth = availableWidth;
            finalHeight = finalWidth / targetRatio;
        }

        wrapper.style.width = finalWidth + 'px';
        wrapper.style.height = finalHeight + 'px';
        
        let dpr = window.devicePixelRatio || 1;
        canvas.width = Math.round(finalWidth * dpr);
        canvas.height = Math.round(finalHeight * dpr);
        canvas.style.width = finalWidth + 'px';
        canvas.style.height = finalHeight + 'px';
        
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        
        scale = finalWidth / LOGICAL_WIDTH;
        
        GAME_OVER_LINE = LOGICAL_HEIGHT * dangerLinePercent;
        let dangerUi = document.getElementById('danger-ui');
        if(dangerUi) {
            dangerUi.style.top = (dangerLinePercent * 100) + '%';
        }
        
        canvasRect = wrapper.getBoundingClientRect();
    }

    function getLogicalMousePos(clientX, clientY = 0) {
        if(!canvasRect) return {x: LOGICAL_WIDTH / 2, y: 0};
        let relativeX = clientX - canvasRect.left;
        let relativeY = clientY - canvasRect.top;
        return {
            x: relativeX / scale,
            y: relativeY / scale
        };
    }

    // --- H·ªÜ TH·ªêNG QUY·ªÄN TR·ª¢ GI√öP ---
    function checkPowerups() {
        let elW = document.getElementById('pu-wildcard');
        let elR = document.getElementById('pu-reroll');
        let elD = document.getElementById('pu-delete');
        
        let canW = score >= 200 && !isTargetingDelete && currentDropItem && !currentDropItem.isWildcard;
        let canR = score >= 50 && !isTargetingDelete && currentDropItem && !currentDropItem.isWildcard;
        let canD = score >= 100;

        if(elW) elW.classList.toggle('disabled', !canW);
        if(elR) elR.classList.toggle('disabled', !canR);
        if(elD) elD.classList.toggle('disabled', !canD);
    }

    function addScore(points) {
        score += points; 
        document.getElementById('score-display').innerText = score;
        checkPowerups();
    }

    function buyWildcard() {
        if (score < 200 || gameState !== 'PLAYING' || !currentDropItem || isTargetingDelete || currentDropItem.isWildcard) return;
        score -= 200;
        addScore(0);
        
        currentDropItem.isWildcard = true;
        currentDropItem.icon = "üåü";
        currentDropItem.radius = LEVELS[0].radius; // Thu nh·ªè l·∫°i th√†nh d·∫°ng Sao
        currentDropItem.mass = 1;
        playSFX(10); 
        checkPowerups();
    }

    function buyReroll() {
        if (score < 50 || gameState !== 'PLAYING' || !currentDropItem || isTargetingDelete || currentDropItem.isWildcard) return;
        score -= 50;
        addScore(0);
        
        // ƒê·ªïi ng·∫´u nhi√™n t·ª´ c·∫•p 1 ƒë·∫øn c·∫•p 4 (Hoa nh·ªè)
        let newLevel = Math.floor(Math.random() * 4); 
        
        let oldX = currentDropItem.x;
        currentDropItem = new Body(oldX, GAME_OVER_LINE - LEVELS[newLevel].radius - 15, newLevel);
        currentDropItem.spawnScale = 1; 
        playSFX(2);
        checkPowerups();
    }

    function buyDelete() {
        if (score < 100 || gameState !== 'PLAYING') return;
        
        if (isTargetingDelete) {
            // H·ªßy ch·ªçn
            isTargetingDelete = false;
            document.getElementById('pu-delete').classList.remove('active');
            document.getElementById('canvas-wrapper').classList.remove('targeting');
            checkPowerups();
            return;
        }
        
        isTargetingDelete = true;
        document.getElementById('pu-delete').classList.add('active');
        document.getElementById('canvas-wrapper').classList.add('targeting');
        checkPowerups();
    }
    // --------------------------------

    function showStartModal() {
        gameState = 'START';
        isTargetingDelete = false;
        document.getElementById('canvas-wrapper').classList.remove('targeting');
        document.getElementById('start-modal').classList.add('active');
        document.getElementById('game-over-modal').classList.remove('active');
        loadPlayerData(); 
    }

    function startGame() {
        let inputName = document.getElementById('player-name-input').value.trim();
        playerName = inputName !== "" ? inputName : "N√¥ng D√¢n";
        localStorage.setItem('skyGardenNameV7', playerName); 
        
        let diffMode = document.getElementById('diff-select').value;
        if (diffMode === 'easy') {
            gameConfig.bounce = 0.15; dangerLinePercent = 0.10; 
        } else if (diffMode === 'hard') {
            gameConfig.bounce = 0.65; dangerLinePercent = 0.28; 
        } else {
            gameConfig.bounce = 0.40; dangerLinePercent = 0.18;
        }
        resizeCanvas();

        document.getElementById('start-modal').classList.remove('active');
        
        bodies = []; particles = []; score = 0;
        document.getElementById('score-display').innerText = 0;
        canDrop = true;
        isTargetingDelete = false;
        document.getElementById('pu-delete').classList.remove('active');
        document.getElementById('canvas-wrapper').classList.remove('targeting');
        
        setNextItem();
        mouseX = LOGICAL_WIDTH / 2;
        createCurrentDropItem();
        
        if(sfxCtx && sfxCtx.state === 'suspended') sfxCtx.resume();
        gameState = 'PLAYING';
    }

    function setNextItem() {
        let rand = Math.random(); 
        if(rand < 0.5) nextItemLevel = 0; else if (rand < 0.85) nextItemLevel = 1; else nextItemLevel = 2;
        document.getElementById('next-item-preview').innerText = LEVELS[nextItemLevel].icon;
    }

    function createCurrentDropItem() {
        let radius = LEVELS[nextItemLevel].radius;
        currentDropItem = new Body(Math.max(radius, Math.min(LOGICAL_WIDTH - radius, mouseX)), GAME_OVER_LINE - radius - 15, nextItemLevel);
        currentDropItem.spawnScale = 1; 
        checkPowerups();
    }

    function handleMove(e) {
        if (gameState !== 'PLAYING' || isTargetingDelete) return;
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let logicalX = getLogicalMousePos(clientX).x;
        mouseX += (logicalX - mouseX) * 0.5;
        if(currentDropItem) {
            let r = currentDropItem.radius;
            currentDropItem.x = Math.max(r, Math.min(LOGICAL_WIDTH - r, mouseX));
        }
    }

    function handleDrop(e) {
        if (gameState !== 'PLAYING') return;

        // X·ª≠ l√Ω khi ƒëang d√πng th·∫ª X√ìA NG·ªåC
        if (isTargetingDelete) {
            let clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            let clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            let coords = getLogicalMousePos(clientX, clientY);
            
            for (let i = bodies.length - 1; i >= 0; i--) {
                let b = bodies[i];
                let dx = b.x - coords.x;
                let dy = b.y - coords.y;
                if (dx*dx + dy*dy <= b.radius*b.radius) {
                    spawnParticles(b.x, b.y, b.color, 20);
                    bodies.splice(i, 1);
                    score -= 100; // Tr·ª´ ƒëi·ªÉm th·ª±c t·∫ø
                    addScore(0);
                    isTargetingDelete = false;
                    document.getElementById('pu-delete').classList.remove('active');
                    document.getElementById('canvas-wrapper').classList.remove('targeting');
                    playSFX(1);
                    checkPowerups();
                    return;
                }
            }
            return; // N·∫øu b·∫•m tr∆∞·ª£t ra ngo√†i th√¨ kh√¥ng m·∫•t ƒëi·ªÉm, v·∫´n gi·ªØ ch·∫ø ƒë·ªô ng·∫Øm
        }

        if (!canDrop || !currentDropItem) return;
        if(e) handleMove(e); 
        playSFX(0);
        bodies.push(currentDropItem);
        currentDropItem = null;
        canDrop = false;
        checkPowerups();
        setTimeout(() => { 
            if (gameState === 'PLAYING') { setNextItem(); createCurrentDropItem(); canDrop = true; } 
        }, 800);
    }

    wrapper.addEventListener('mousemove', handleMove);
    wrapper.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});
    wrapper.addEventListener('mousedown', handleDrop);
    wrapper.addEventListener('touchstart', (e) => { e.preventDefault(); handleDrop(e); }, {passive: false});

    class Body {
        constructor(x, y, levelIndex) {
            let def = LEVELS[levelIndex];
            this.x = x; this.y = y; this.vx = 0; this.vy = 0;
            this.levelIndex = levelIndex; this.radius = def.radius;
            this.mass = def.mass; this.color = def.color; this.icon = def.icon;
            this.markedForMerge = false; this.spawnScale = 0; 
            this.isWildcard = false;
        }

        update() {
            if (this.spawnScale < 1) { this.spawnScale += 0.08; if (this.spawnScale > 1) this.spawnScale = 1; }
            
            this.vy += 0.8; 
            this.vx *= 0.99; this.vy *= 0.99;
            this.x += this.vx; this.y += this.vy;
            let currentBounce = gameConfig.bounce;

            if (this.x - this.radius < 0) { this.x = this.radius; this.vx *= -currentBounce; }
            else if (this.x + this.radius > LOGICAL_WIDTH) { this.x = LOGICAL_WIDTH - this.radius; this.vx *= -currentBounce; }

            if (this.y + this.radius > LOGICAL_HEIGHT) {
                this.y = LOGICAL_HEIGHT - this.radius; this.vy *= -currentBounce; this.vx *= 0.8; 
            }
        }

        draw(ctx) {
            ctx.save(); 
            let rx = this.x * scale;
            let ry = this.y * scale;
            ctx.translate(rx, ry); 
            
            let renderRadius = this.radius * scale * this.spawnScale;
            
            ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = renderRadius * 0.3; ctx.shadowOffsetY = 2;
            ctx.beginPath(); ctx.arc(0, 0, renderRadius, 0, Math.PI * 2); 
            
            // V·∫Ω ri√™ng cho Th·∫ª V·∫°n NƒÉng
            if (this.isWildcard) {
                let grad = ctx.createRadialGradient(
                    Math.round(-renderRadius * 0.2), Math.round(-renderRadius * 0.2), Math.round(renderRadius * 0.1), 
                    0, 0, renderRadius
                );
                grad.addColorStop(0, '#fff'); grad.addColorStop(0.3, '#fbc2eb');
                grad.addColorStop(0.7, '#a1c4fd'); grad.addColorStop(1, '#ff9a9e');
                ctx.fillStyle = grad;
            } else {
                ctx.fillStyle = this.color; 
            }
            ctx.fill();

            ctx.beginPath(); ctx.ellipse(-renderRadius * 0.2, -renderRadius * 0.3, renderRadius * 0.5, renderRadius * 0.25, -Math.PI / 6, 0, Math.PI * 2);
            let glassGrad = ctx.createLinearGradient(0, -renderRadius, 0, 0);
            glassGrad.addColorStop(0, "rgba(255, 255, 255, 0.8)"); glassGrad.addColorStop(1, "rgba(255, 255, 255, 0)");
            ctx.fillStyle = glassGrad; ctx.fill();

            ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
            ctx.font = `${renderRadius}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.icon, 0, renderRadius * 0.1);
            ctx.restore();
        }
    }

    function resolveCollisions() {
        let mergesThisFrame = [];
        for (let i = 0; i < bodies.length; i++) {
            for (let j = i + 1; j < bodies.length; j++) {
                let a = bodies[i], b = bodies[j];
                let dx = b.x - a.x, dy = b.y - a.y;
                let distSq = dx * dx + dy * dy, minDist = a.radius + b.radius;

                if (distSq < minDist * minDist && distSq > 0) {
                    let dist = Math.sqrt(distSq), overlap = minDist - dist;

                    // X·ª≠ l√Ω Th·∫ª V·∫°n NƒÉng ƒÉn ng·ªçc
                    if ((a.isWildcard || b.isWildcard) && !a.markedForMerge && !b.markedForMerge) {
                        let normalBody = a.isWildcard ? b : a;
                        if (!normalBody.isWildcard) {
                            a.markedForMerge = true; b.markedForMerge = true;
                            let targetLevel = normalBody.levelIndex + 1;
                            if (targetLevel > LEVELS.length - 1) targetLevel = LEVELS.length - 1; 
                            mergesThisFrame.push({
                                a: a, b: b, level: targetLevel, x: normalBody.x, y: normalBody.y
                            });
                            continue;
                        }
                    }
                    // H·ª£p nh·∫•t th√¥ng th∆∞·ªùng
                    else if (a.levelIndex === b.levelIndex && !a.markedForMerge && !b.markedForMerge) {
                        if (a.levelIndex < LEVELS.length - 1) {
                            a.markedForMerge = true; b.markedForMerge = true;
                            mergesThisFrame.push({a, b, level: a.levelIndex + 1, x: (a.x + b.x)/2, y: (a.y + b.y)/2}); continue;
                        }
                    }

                    // T∆∞∆°ng t√°c v·∫≠t l√Ω ƒë·∫©y nhau
                    let nx = dx / dist, ny = dy / dist;
                    let correction = Math.max(overlap - 0.1, 0) / ((1/a.mass) + (1/b.mass)) * 0.5;
                    a.x -= nx * correction / a.mass; a.y -= ny * correction / a.mass;
                    b.x += nx * correction / b.mass; b.y += ny * correction / b.mass;

                    let rvx = b.vx - a.vx, rvy = b.vy - a.vy;
                    let velAlongNormal = rvx * nx + rvy * ny;
                    if (velAlongNormal > 0) continue; 

                    let currentBounce = gameConfig.bounce;
                    let jVal = -(1 + currentBounce) * velAlongNormal; 
                    jVal /= (1/a.mass + 1/b.mass);
                    
                    a.vx -= jVal * nx / a.mass; a.vy -= jVal * ny / a.mass;
                    b.vx += jVal * nx / b.mass; b.vy += jVal * ny / b.mass;
                }
            }
        }

        if (mergesThisFrame.length > 0) {
            bodies = bodies.filter(b => !b.markedForMerge); 
            mergesThisFrame.forEach(m => {
                let newBody = new Body(m.x, m.y, m.level); newBody.vy = -2; bodies.push(newBody);
                addScore(LEVELS[m.level].points); 
                spawnParticles(m.x, m.y, LEVELS[m.level].color, 15);
                playSFX(m.level);
            });
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; let angle = Math.random() * Math.PI * 2, speed = Math.random() * 6 + 2;
            this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
            this.life = 1.0; this.color = color; this.size = Math.random() * 6 + 3;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.03; this.size *= 0.95; }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
            ctx.beginPath(); 
            let rx = this.x * scale; let ry = this.y * scale; let rs = Math.max(1, this.size * scale);
            ctx.arc(rx, ry, rs, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0;
        }
    }
    function spawnParticles(x, y, color, count) { for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color)); }

    function checkGameOver() {
        let isOver = false;
        for (let i = 0; i < bodies.length; i++) {
            let b = bodies[i];
            if (b.y - b.radius < GAME_OVER_LINE) {
                if (Math.abs(b.vy) < 1 && Math.abs(b.vx) < 1) { 
                    b.dangerTimer = (b.dangerTimer || 0) + 1; 
                    if (b.dangerTimer > 120) { isOver = true; break; } 
                }
                else b.dangerTimer = 0;
            } else b.dangerTimer = 0;
        }
        if (isOver) { 
            gameState = 'GAMEOVER'; 
            document.getElementById('final-score').innerText = score;
            saveScore(); 
            document.getElementById('game-over-modal').classList.add('active'); 
        }
    }

    function gameLoop() {
        if(!canvasRect || canvasRect.width === 0) { requestAnimationFrame(gameLoop); return; }
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // K·ªπ nƒÉng ng·∫Øm: V·∫Ω l·ªõp ph·ªß t·ªëi t·∫≠p trung
        if (isTargetingDelete) {
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#fff";
            ctx.font = "900 " + Math.round(30 * scale) + "px Nunito";
            ctx.textAlign = "center";
            ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10;
            ctx.fillText("CH·∫†M V√ÄO NG·ªåC ƒê·ªÇ X√ìA", canvas.width/2, canvas.height/2);
            ctx.shadowBlur = 0;
        }

        // ƒê√≥ng bƒÉng v·∫≠t l√Ω n·∫øu ƒëang ng·∫Øm x√≥a
        if (gameState === 'PLAYING' && !isTargetingDelete) {
            for (let s = 0; s < 6; s++) { bodies.forEach(b => b.update()); resolveCollisions(); }
            checkGameOver();
        }

        bodies.forEach(b => {
            b.draw(ctx);
            if (b.dangerTimer > 0) { 
                ctx.beginPath();
                let dangerX = b.x * scale; let dangerY = b.y * scale; let dangerR = (b.radius + Math.sin(Date.now()/100)*5) * scale;
                ctx.arc(dangerX, dangerY, dangerR, 0, Math.PI*2); 
                ctx.strokeStyle = "rgba(255, 71, 87,0.8)"; ctx.lineWidth = 3; ctx.stroke(); 
            }
        });

        for (let i = particles.length - 1; i >= 0; i--) { 
            particles[i].update(); particles[i].draw(ctx); 
            if (particles[i].life <= 0) particles.splice(i, 1); 
        }

        // ·∫®n v·∫≠t ph·∫©m ƒëang r·ªõt n·∫øu ƒëang b·∫≠n ng·∫Øm x√≥a
        if (currentDropItem && (gameState === 'PLAYING' || gameState === 'START') && !isTargetingDelete) {
            ctx.globalAlpha = 0.8;
            let guideX = currentDropItem.x * scale;
            let guideY = (currentDropItem.y + currentDropItem.radius) * scale;
            
            ctx.beginPath(); ctx.moveTo(guideX, guideY);
            ctx.lineTo(guideX, canvas.height); 
            ctx.strokeStyle = "rgba(255, 255, 255, 0.6)"; ctx.lineWidth = 2; ctx.setLineDash([8, 8]); ctx.stroke(); ctx.setLineDash([]);
            
            ctx.globalAlpha = 1.0; 
            currentDropItem.draw(ctx);
        }

        requestAnimationFrame(gameLoop);
    }

    function playSFX(level) {
        if (!sfxCtx || sfxCtx.state !== 'running' || !isBgmPlaying) return;
        try {
            const osc = sfxCtx.createOscillator();
            const gain = sfxCtx.createGain();
            osc.type = 'sine';
            let startFreq = 300 + level * 40, endFreq = 600 + level * 80;
            osc.frequency.setValueAtTime(startFreq, sfxCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(endFreq, sfxCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, sfxCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, sfxCtx.currentTime + 0.15);
            osc.connect(gain); gain.connect(sfxCtx.destination);
            osc.start(); osc.stop(sfxCtx.currentTime + 0.2);
        } catch(e) {}
    }

    function toggleBGM() {
        isBgmPlaying = !isBgmPlaying;
        document.getElementById('music-btn').innerText = isBgmPlaying ? "üéµ" : "üîá";
        if(isBgmPlaying && sfxCtx.state === 'suspended') sfxCtx.resume();
    }

    initApp();
    requestAnimationFrame(gameLoop);

</script>
</body>
</html>
